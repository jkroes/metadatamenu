# Metadata Menu Plugin

## Overview

This is a fork of the [Metadata Menu](https://github.com/mdelobelle/metadatamenu) plugin for [Obsidian](https://obsidian.md/). The plugin manages note metadata (frontmatter and dataview inline fields) through context menus, modals, autocompletion, and dataview table integration. Users define typed field presets globally or per-fileClass.

## Tech Stack

- **Language:** TypeScript 4.7, targeting ES6
- **Bundler:** ESBuild
- **CSS:** Sass/SCSS
- **Key dependencies:** Obsidian API, CodeMirror 6, `yaml`, `@popperjs/core`
- **Linting:** ESLint with `@typescript-eslint`

## Project Structure

```
.
├── src/                    # TypeScript source (~124 files)
│   ├── fields/             # Field type system and base classes
│   │   ├── base/           # Abstract base classes (BaseField, BaseModal, BaseSetting)
│   │   └── models/         # Individual field type implementations (22 types)
│   ├── fileClass/          # FileClass structured data types and views
│   │   └── views/          # Table views, settings, code block views
│   ├── index/              # Field indexing and caching (FieldIndex, FieldIndexBuilder)
│   ├── commands/           # Command palette and field modifier commands
│   ├── components/         # UI components (ContextMenu, ExtraButton, etc.)
│   ├── note/               # Note parsing and metadata extraction
│   ├── settings/           # Settings UI and configuration
│   ├── db/                 # IndexedDB wrapper for caching
│   ├── suggester/          # Autocomplete/suggestion system
│   ├── options/            # Context menu options and property updates
│   ├── modals/             # Modal dialogs
│   ├── utils/              # Helpers (parser, dataviewUtils, fileUtils, etc.)
│   ├── testing/            # Built-in test runner and test suites
│   ├── assets/css/         # SCSS stylesheets (12 files)
│   ├── types/              # TypeScript type definitions
│   ├── typings/            # Ambient TypeScript declarations (globals.d.ts, types.d.ts)
│   ├── propertyWidgets/    # Property panel monkey-patching (PropertyPatchManager + suggest classes)
│   └── MetadataMenuApi.ts  # Public API
├── main.ts                 # Plugin entry point
├── docs/                   # MkDocs documentation (fields, fileclasses, api, etc.)
├── test-vault-mdm/         # Test Obsidian vault with fixtures
├── manifest.json           # Obsidian plugin manifest
├── package.json            # Dependencies and build scripts
├── esbuild.config.mjs      # ESBuild bundler configuration
├── env.js                  # Generated by esbuild (sets window.MDM_DEBUG); do not edit manually
├── tsconfig.json           # TypeScript configuration
├── styles.css              # Compiled CSS output
└── versions.json           # Version-to-Obsidian-version mapping
```

## Build & Development

Run `npm run build && npm run build:css` to build everything and copy all outputs (`main.js`, `manifest.json`, `styles.css`) to `test-vault-mdm/.obsidian/plugins/metadata-menu/`. Do this after any changes that require user testing in Obsidian.

For active development, run `npm run dev` to watch JS changes (copies `main.js`/`manifest.json` automatically) and `npm run build:css:watch` in a second terminal to watch SCSS changes. The `MDM_DEBUG` flag (controlled by esbuild define) enables debug logging; `npm run dev:silent` disables it. Use `npm run version` to bump the version in `manifest.json` and `versions.json`.

## Testing

The plugin uses a custom built-in test runner (`src/testing/runner.ts`) that runs inside Obsidian against the test vault at `test-vault-mdm/`. Tests cover settings creation, fileClass creation, and field modal interactions. There is no CLI test harness.

After rebuilding, reload the plugin inside Obsidian (Settings → Community Plugins → disable/enable, or use the Obsidian reload command) to pick up changes.

## Key Concepts

- **Field types:** 22 types implemented in `src/fields/models/`: Boolean, Canvas, CanvasGroup, CanvasGroupLink, Cycle, Date, DateTime, File, Formula, Input, JSON, Lookup, Media, Multi, MultiFile, MultiMedia, Number, Object, ObjectList, Select, Time, YAML. Abstract base classes in `src/fields/base/`.
- **FileClasses:** Structured data type definitions that assign field schemas to notes based on folder, tag, or explicit assignment. Defined in `src/fileClass/`
- **Field Index:** Caching layer (`src/index/FieldIndex.ts`) that discovers and indexes fields across the vault, backed by IndexedDB (`src/db/`)
- **Controls:** Multiple UI entry points — context menus, editor autocompletion, dataview tables, metadata buttons, modals
- **API:** `MetadataMenuApi` (`src/MetadataMenuApi.ts`) exposes `getValues()`, `fieldModifier()`, `postValues()`, etc.

## Resources

- [Metadata Menu User Guide](https://mdelobelle.github.io/metadatamenu/)
- [Original Metadata Menu Repo](https://github.com/mdelobelle/metadatamenu)
- [Obsidian Developer Docs](https://docs.obsidian.md/Home)
- [Obsidian User Guide](https://help.obsidian.md/)
- [Obsidian Forum](https://forum.obsidian.md)
- [Obsidian Community Plugins](https://obsidian.md/plugins)

## Notes for Claude

- When adding components that inject DOM elements (file explorer, properties panel, etc.), always add corresponding cleanup in `onunload()` in `main.ts`. The current `onunload()` is minimal — missing cleanup causes stale UI after plugin disable.
- Use optional chaining (`?.`) when accessing Obsidian internal view state (e.g. `explorerView?.fileItems?.[path]`) in unload/cleanup paths — Obsidian may have already torn down view internals by that point.
- Commands run in a sandbox by default. If a command fails with a permission or "operation not permitted" error, retry with `dangerouslyDisableSandbox: true`. Known sandbox incompatibilities:
  - `git commit -m "$(cat <<'EOF' ... EOF)"` — here-document temp file creation always fails in sandbox; use a plain `-m "..."` string instead.
  - `esbuild.config.mjs` copyPlugin has an async/process.exit race condition — `npm run build` may not copy `main.js` reliably; always use an explicit `cp main.js test-vault-mdm/.obsidian/plugins/metadata-menu/main.js` with `dangerouslyDisableSandbox: true` instead.
- Field type implementations follow a consistent pattern — check an existing model in `src/fields/models/` before adding or modifying one.
- FileClass views (`src/fileClass/views/`) contain substantial UI logic including table view components with filtering and sorting.
- Settings migration logic lives in `src/settings/migrateSetting.ts` — account for it when changing settings interfaces.
- The plugin supports both YAML frontmatter and dataview inline field syntax (`field::value`). Changes to parsing must handle both.
- Optional Dataview plugin integration exists in `src/utils/dataviewUtils.ts`.
- Prefer minimal, focused changes. Don't over-engineer.
